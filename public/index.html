<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ESP32 Cámara - Monitor</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
    .container { max-width: 600px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0002; padding: 2em; }
    h1 { color: #2c3e50; }
    img { max-width: 100%; border-radius: 6px; margin-bottom: 1em; }
    .info { color: #555; margin-bottom: 1em; }
    .alert { color: #c0392b; font-weight: bold; }
    .gallery { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 2em; }
    .gallery img { width: 90px; height: 70px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 2px solid #eee; transition: border 0.2s; }
    .gallery img:hover { border: 2px solid #2980b9; }
    .alertHistory { color: #c0392b; padding-left: 1em; margin-top: 2em; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Monitor ESP32 Cámara</h1>
    <div class="info">Última imagen recibida:</div>
    <img id="lastImage" src="/uploads/placeholder.jpg" alt="Última imagen" />
    <div id="alert" class="alert"></div>
    <button onclick="refreshImage()">Actualizar</button>
    <div class="info" style="margin-top:2em;">Historial de alertas de movimiento:</div>
    <ul id="alertHistory" style="color:#c0392b; padding-left:1em;"></ul>
    <div class="info" style="margin-top:2em;">Galería de últimas imágenes:</div>
    <div class="gallery" id="gallery"></div>
  </div>
  <script>
    async function fetchLastImage() {
      const res = await fetch('/last');
      const data = await res.json();
      if(data.file) {
        document.getElementById('lastImage').src = '/uploads/' + data.file + '?t=' + Date.now();
      }
      if(data.alert) {
        document.getElementById('alert').innerText = data.alert;
      } else {
        document.getElementById('alert').innerText = '';
      }
    }
    async function fetchGallery() {
      const res = await fetch('/gallery');
      const data = await res.json();
      const gallery = document.getElementById('gallery');
      gallery.innerHTML = '';
      if(data.files && data.files.length) {
        data.files.forEach(file => {
          const img = document.createElement('img');
          img.src = '/uploads/' + file + '?t=' + Date.now();
          img.alt = file;
          img.onclick = () => {
            document.getElementById('lastImage').src = img.src;
          };
          gallery.appendChild(img);
        });
      } else {
        gallery.innerHTML = '<em>No hay imágenes recientes.</em>';
      }
    }
    async function fetchAlertHistory() {
      const res = await fetch('/alerts');
      const data = await res.json();
      const alertHistory = document.getElementById('alertHistory');
      alertHistory.innerHTML = '';
      if(data.alerts && data.alerts.length) {
        data.alerts.forEach(alert => {
          const li = document.createElement('li');
          const date = new Date(alert.timestamp);
          li.textContent = `${date.toLocaleString()} - ${alert.message}`;
          alertHistory.appendChild(li);
        });
      } else {
        alertHistory.innerHTML = '<em>No hay alertas recientes.</em>';
      }
    }
    function refreshImage() {
      fetchLastImage();
      fetchGallery();
      fetchAlertHistory();
    }
    window.onload = () => {
      fetchLastImage();
      fetchGallery();
      fetchAlertHistory();
      setInterval(() => {
        fetchLastImage();
        fetchGallery();
        fetchAlertHistory();
      }, 5000); // Actualiza cada 5 segundos
    };
  </script>
</body>
</html>
